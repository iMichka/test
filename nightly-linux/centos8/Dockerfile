FROM centos:8

# Fix: Failed to download metadata for repo 'appstream': Cannot prepare internal mirrorlist: No URLs in mirrorlist
RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
RUN sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

# hadolint ignore=DL3008
RUN yum -y update \
   && yum groupinstall -y 'Development Tools' \
   && yum install -y procps-ng curl file

# For git:
RUN yum install -y zlib-devel
# For curl:
RUN yum install -y openssl-devel

RUN curl -sL http://ftp.gnu.org/gnu/tar/tar-1.32.tar.gz | tar xz \
    && cd /tar-1.32 \
    && FORCE_UNSAFE_CONFIGURE=1 ./configure --prefix=/usr/local \
    && make install \
    && cd / \
    && rm -rf /tar-1.32

RUN curl -sL http://fresh-center.net/linux/www/curl-7.82.0.tar.bz2 | tar xj \
    && cd /curl-7.82.0 \
    && make configure \
    && ./configure --prefix=/usr/local --with-openssl \
    && make \
    && make install \
    && cd / \
    && rm -rf /curl-7.82.0

RUN curl -sL http://mirrors.edge.kernel.org/pub/software/scm/git/git-2.28.0.tar.gz | tar xz \
    && cd /git-2.28.0 \
    && make configure \
    && ./configure --prefix=/usr/local --with-curl=/usr/local \
    && make install NO_TCLTK=1 \
    && cd / \
    && rm -rf /git-2.28.0

ENV HOMEBREW_GIT_PATH=/usr/local/bin/git
ENV HOMEBREW_CURL_PATH=/usr/local/bin/curl
ENV HOMEBREW_FORCE_BREWED_CA_CERTIFICATES=1

RUN useradd -m -s /bin/bash linuxbrew
RUN echo 'linuxbrew ALL=(ALL) NOPASSWD:ALL' >>/etc/sudoers
RUN su - linuxbrew -c 'mkdir ~/.linuxbrew'

RUN /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

RUN chown -R linuxbrew /home/linuxbrew/.linuxbrew

RUN echo "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" >> /home/linuxbrew/.bashrc
RUN echo "export HOMEBREW_GIT_PATH=/usr/local/bin/git" >> /home/linuxbrew/.bashrc
RUN echo "export HOMEBREW_CURL_PATH=/usr/local/bin/curl" >> /home/linuxbrew/.bashrc
RUN echo "export HOMEBREW_FORCE_BREWED_CA_CERTIFICATES=1" >> /home/linuxbrew/.bashrc
# This is necessary so that HOMEBREW_GIT_PATH and HOMEBREW_CURL_PATH are picked up by brew:
RUN echo "export HOMEBREW_DEVELOPER=1" >> /home/linuxbrew/.bashrc